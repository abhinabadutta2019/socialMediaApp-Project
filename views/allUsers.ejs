<%- include('partials/header') %>

<h2>User You may know</h2>

<div>
  <% if (allUsers.length>0) { %> <% for( let i = 0; i < allUsers.length; i++ ) {
  %>

  <li id="<%= allUsers[i]._id %>">
    <!--  -->
    <% if (allUsers[i].photoPath) { %>
    <div>
      <img
        src="<%= allUsers[i].photoPath %>"
        alt="image"
        width="200"
        height="150"
      />
    </div>
    <% } %>
    <!--  -->
    <p>userName:<%= allUsers[i].username %></p>
    <p>followers:<%= allUsers[i].followers.length %></p>
    <p>followings:<%= allUsers[i].followings.length %></p>
    <!--user details button -->
    <button onclick="getUser()">Details</button>
    <!-- follow button -->
    <button onclick="followUser()">Follow</button>
    <!--  -->
    <button onclick="unFollowUser()">unFollow</button>
  </li>
  <% } %> <% } else{%>
  <p>No user found</p>
  <%}%>
</div>

<script>
  //
  let message = document.getElementById("message");
  message.textContent = "";
  //
  async function unFollowUser() {
    try {
      const unFollowButton = event.target;
      const unFollowButtonParent = unFollowButton.parentElement;
      const unParentId = unFollowButtonParent.id;
      // console.log(unParentId, "unParentId");
      const response = await fetch(
        `${window.location.origin}/user/unfollow/${unParentId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      //result of the fetch/await
      const result = await response.json();

      console.log(result, "result");

      if (result.message) {
        //
        message.textContent = result.message;
        //
        setTimeout(function () {
          //
          window.location.href = window.location.href;
        }, 1000);
      }
    } catch (err) {
      console.log(err);
    }
  }
  //
  async function followUser() {
    try {
      const followButton = event.target;
      const followButtonParent = followButton.parentElement;
      const parentId = followButtonParent.id;
      //
      const response = await fetch(
        `${window.location.origin}/user/follow/${parentId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );
      //result of the fetch/await
      const result = await response.json();
      //
      console.log(result, "result");
      //follow successful hole tokhon e reload

      //
      if (result.message) {
        //
        message.textContent = result.message;
        //
        setTimeout(function () {
          //
          window.location.href = window.location.href;
        }, 1000);
      }

      //
    } catch (err) {
      console.log(err);
    }
  }

  //Details button = get user detail from all user page
  async function getUser() {
    try {
      //   const id = event.target.id;
      //   console.log(id);
      const buttonDetail = event.target;
      //to get the id of the <li>
      const buttonParent = buttonDetail.parentElement;
      //   console.log(buttonDetail);

      const id = buttonParent.id;

      //   console.log(id, "id");

      await fetch(`${window.location.origin}/user/getUser/${id}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });

      //   console.log(`${window.location.origin}/user/getUser`);
      //
      window.location.href = `${window.location.origin}/user/getUser/${id}`;
    } catch (err) {
      console.log(err);
    }
  }
</script>
